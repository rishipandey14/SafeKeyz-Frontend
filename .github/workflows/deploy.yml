name: Deploy SafeKeyz Frontend

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allow manual triggering

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¦ Checkout Code
        uses: actions/checkout@v4
      
      - name: ğŸš€ Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          command_timeout: 30m
          script: |
            set -e  # Exit on any error
            
            echo "ğŸ” Starting deployment at $(date)"
            
            # Navigate to project directory
            cd /home/ubuntu/project/SafeKeyz-Frontend
            
            # Pull latest changes
            echo "ğŸ“¥ Pulling latest code from GitHub..."
            git config --global --add safe.directory /home/ubuntu/project/SafeKeyz-Frontend
            git fetch origin main
            git reset --hard origin/main
            
            # Navigate to infra directory
            cd /home/ubuntu/project/infra
            
            # Stop existing containers
            echo "ğŸ›‘ Stopping existing containers..."
            docker-compose -f docker-compose.prod.yml down || true
            
            # Remove old images to free space
            echo "ğŸ§¹ Cleaning up old Docker images..."
            docker image prune -af --filter "until=24h" || true
            
            # Build new image
            echo "ğŸ—ï¸ Building new Docker image..."
            docker-compose -f docker-compose.prod.yml build --no-cache
            
            # Start containers
            echo "â–¶ï¸ Starting containers..."
            docker-compose -f docker-compose.prod.yml up -d
            
            # Wait for container to be healthy
            echo "â³ Waiting for container to be ready..."
            sleep 10
            
            # Check if container is running
            if docker ps | grep -q safekeyz-frontend; then
              echo "âœ… Deployment successful!"
              docker ps | grep safekeyz-frontend
            else
              echo "âŒ Deployment failed! Container is not running."
              docker logs safekeyz-frontend --tail 50
              exit 1
            fi
            
            echo "ğŸ‰ Deployment completed at $(date)"
      
      - name: ğŸ“Š Deployment Status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… Deployment to EC2 was successful!"
          else
            echo "âŒ Deployment to EC2 failed!"
          fi